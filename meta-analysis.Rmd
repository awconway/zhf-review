---
title: "Accuracy of zero heat flux temperature measurements"
output: html_document
---

Functions for calculating Bland-Altman meta-analysis

```{r echo=FALSE}
meta <-  function(Te,V_T){
m <- length(Te)
wt_FE=1/V_T
T_FE <- sum(Te*wt_FE)/sum(wt_FE)
Q <- sum(wt_FE*(Te - T_FE)^2)
S1 <- sum(wt_FE)
S2 <- sum(wt_FE^2)
o2 <- (Q - (m - 1))/(S1 - S2/S1)
wt_RE <- 1/(V_T + o2)
T_RE <- sum(Te*wt_RE)/sum(wt_RE)
V_T_RE_mod <- 1/sum(wt_RE)
V_T_RE_rve <- (m/(m-1))*sum(wt_RE^2*(Te - T_RE)^2)/(sum(wt_RE))^2
c(m,T_RE,o2,V_T_RE_mod, V_T_RE_rve)
}
loa_maker <- function(bias,V_bias,logs2,V_logs2) {
bias_row=meta(bias, V_bias)
logs2_row=meta(logs2, V_logs2)
bias_mean <- bias_row[2]
sd2_est <- exp(logs2_row[2])
tau_est <- bias_row[3]
LOA_L <- bias_mean - 2*sqrt(sd2_est + tau_est)
LOA_U <- bias_mean + 2*sqrt(sd2_est + tau_est)
m <- bias_row[1]
tcrit <- qt(1-.05/2,m-1)
B1 <- sd2_est^2/(sd2_est + tau_est)
B2 <- tau_est^2/(sd2_est + tau_est)
wt <- 1/V_bias
S1 <- sum(wt)
S2 <- sum(wt^2)
S3 <- sum(wt^3)
A0 <- 2*(m-1)/(S1-S2/S1)^2
A1 <- 4/(S1 - S2/S1)
A2 <- 2*(S2-2*S3/S1+S2^2/S1^2)/(S1-S2/S1)^2
V_logT2 <- A0/tau_est^2 + A1/tau_est + A2
V_logT2 <- 2/sum((V_bias + tau_est)^(-2))
V_LOA_mod <- bias_row[4] + B1*logs2_row[4] + B2*V_logT2
V_LOA_rve <- bias_row[5] + B1*logs2_row[5] + B2*V_logT2
CI_L_mod <- LOA_L - tcrit*sqrt(V_LOA_mod)
CI_U_mod <- LOA_U + tcrit*sqrt(V_LOA_mod)
CI_L_rve <- LOA_L - tcrit*sqrt(V_LOA_rve)
CI_U_rve <- LOA_U + tcrit*sqrt(V_LOA_rve)
c(m, bias_mean,sqrt(sd2_est), tau_est, LOA_L, LOA_U, CI_L_mod, CI_U_mod, CI_L_rve, CI_U_rve)}
```


##Legend:

Bias=pooled estimate of mean differences calculated as PaCO2-TcCO2 in mmHg

SD=pooled standard deviation of differences

tau2=Variation in bias between studies

LoA_L LoA_U = Lower and upper 95% limit of agreement calculated from pooled estimates of bias and standard deviation of differences

CI_Lm CI_Um = Model-based random-effects meta-analysis estimate of CI for LOA

CI_Lr CI_Ur = Robust variance estimation meta-analysis estimate of CI for LOA

#Primary meta-analysis (all included studies)
```{r}
library(tidyverse)
data <- readxl::read_xlsx("zhf_extracted.xlsx")
sum_findings <- readxl::read_xlsx("sum_findings.xlsx")

data <- data %>%

  mutate(c = N/n)

#variance

data <-  if (data$corrected == "Yes"){

  mutate(data, s2 = ((upper - bias)/1.96)^2)

  } else {

    mutate(data, s2 = ((upper - bias)/1.96)^2)*((N-1)/(N-c))

    }

data <- data %>% 
  mutate(V_bias = s2/n)

data <- data %>% 
  mutate(logs2 = log(s2)+1/(n-1))

data <- data %>% 
  mutate(V_logs2 = 2/(n-1))

data_NPA <- data %>% 
  filter(comparison == "NPA")

data_SL <- data %>% 
  filter(comparison == "Sublingual")

data_core <- data %>% #eshragi overall
  filter(comparison=="PA"|comparison=="Bladder"|comparison=="Eso" | comparison =="Rectal"|comparison =="Ax"|comparison =="Iliac") %>%
  filter(comments != "Intraoperative, off cardiopulmonary bypass" & comments != "Postoperative")

data_core_lowrisk <- data_core %>% #eshragi overall
  filter(RoB_selection == "low" & RoB_spoton == "low" & RoB_comparator == "low" & RoB_flow =="low")

data_core_op <- data%>% #eshragi intraop
    filter(comparison=="PA"|comparison=="Bladder"|comparison=="Eso" | comparison =="Rectal"|comparison =="Ax"|comparison =="Iliac") %>%
  filter (clinical_setting=="Intraoperative")

data_core_icu <- data %>% #eshragi postop
      filter(comparison=="PA"|comparison=="Bladder"|comparison=="Eso" | comparison =="Rectal"|comparison =="Ax"|comparison =="Iliac") %>%
  filter(clinical_setting=="ICU" | clinical_setting=="Postoperative")

```


```{r}
out <- loa_maker(data_core$bias,data_core$V_bias,data_core$logs2,data_core$V_logs2)
out <- round(out, digits=3)
out <- append(out, sum(data_core$n_count, na.rm=T))
out <- append(out, sum(data_core$N, na.rm = T))
names(out) <- c("studies","bias","sd","tau2","LOA_L","LOA_U","CI_Lm","CI_Um","CI_Lr","CI_Ur", "n", "N")
out[1:12]
```

```{r}
out <- loa_maker(data_NPA$bias,data_NPA$V_bias,data_NPA$logs2,data_NPA$V_logs2)
out <- round(out, digits=3)
out <- append(out, sum(data_NPA$n_count, na.rm=T))
out <- append(out, sum(data_NPA$N, na.rm = T))
names(out) <- c("studies","bias","sd","tau2","LOA_L","LOA_U","CI_Lm","CI_Um","CI_Lr","CI_Ur", "n", "N")
out[1:12]
```

```{r}
out <- loa_maker(data_SL$bias,data_SL$V_bias,data_SL$logs2,data_SL$V_logs2)
out <- round(out, digits=3)
out <- append(out, sum(data_SL$n_count, na.rm=T))
out <- append(out, sum(data_SL$N, na.rm = T))
names(out) <- c("studies","bias","sd","tau2","LOA_L","LOA_U","CI_Lm","CI_Um","CI_Lr","CI_Ur", "n", "N")
out[1:12]
```

```{r}
out <- loa_maker(data_core_lowrisk$bias,data_core_lowrisk$V_bias,data_core_lowrisk$logs2,data_core_lowrisk$V_logs2)
out <- round(out, digits=3) 
out <- append(out, sum(data_core_lowrisk$n_count, na.rm=T))
out <- append(out, sum(data_core_lowrisk$N, na.rm = T))
names(out) <- c("studies","bias","sd","tau2","LOA_L","LOA_U","CI_Lm","CI_Um","CI_Lr","CI_Ur", "n", "N")
out[1:12]
```
```{r}
out <- loa_maker(data_core_op$bias,data_core_op$V_bias,data_core_op$logs2,data_core_op$V_logs2)
out <- round(out, digits=3) 
out <- append(out, sum(data_core_op$n_count, na.rm=T))
out <- append(out, sum(data_core_op$N, na.rm = T))
names(out) <- c("studies","bias","sd","tau2","LOA_L","LOA_U","CI_Lm","CI_Um","CI_Lr","CI_Ur", "n", "N")
out[1:12]
```
```{r}
out <- loa_maker(data_core_icu$bias,data_core_icu$V_bias,data_core_icu$logs2,data_core_icu$V_logs2)
out <- round(out, digits=3) 
out <- append(out, sum(data_core_icu$n_count, na.rm=T))
out <- append(out, sum(data_core_icu$N, na.rm = T))
names(out) <- c("studies","bias","sd","tau2","LOA_L","LOA_U","CI_Lm","CI_Um","CI_Lr","CI_Ur", "n", "N")
out[1:12]
```
,#end fluid Row
            column(12,
                   htmlOutput("selected_subset"),
                   DT::dataTableOutput("summary"))),